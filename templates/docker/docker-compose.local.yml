services:
  # Main Coolify Application - Local Development
  coolify:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: coolify-app-local
    restart: unless-stopped
    ports:
      - "8000:80"
    environment:
      APP_NAME: Coolify
      APP_ENV: local
      APP_DEBUG: "true"
      APP_URL: http://localhost:8000
      APP_KEY: ${APP_KEY:-base64:your-local-app-key-here}
      DB_CONNECTION: pgsql
      DB_HOST: coolify-db
      DB_PORT: 5432
      DB_DATABASE: coolify
      DB_USERNAME: coolify
      DB_PASSWORD: ${DB_PASSWORD:-coolify_local_secret}
      REDIS_HOST: coolify-redis
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis_local_secret}
      REDIS_PORT: 6379
      CACHE_STORE: redis
      SESSION_DRIVER: redis
      QUEUE_CONNECTION: redis
      BROADCAST_DRIVER: pusher
      PUSHER_APP_ID: "coolify"
      PUSHER_APP_KEY: "coolify"
      PUSHER_APP_SECRET: "coolify"
      PUSHER_HOST: coolify-realtime
      PUSHER_PORT: 6001
      PUSHER_SCHEME: http
      PUSHER_APP_CLUSTER: mt1
    volumes:
      - coolify-storage:/var/www/html/storage
      - /var/run/docker.sock:/var/run/docker.sock
      - ./app:/var/www/html/app:cached
      - ./config:/var/www/html/config:cached
      - ./database:/var/www/html/database:cached
      - ./resources:/var/www/html/resources:cached
      - ./routes:/var/www/html/routes:cached
    depends_on:
      coolify-db:
        condition: service_healthy
      coolify-redis:
        condition: service_healthy
      coolify-realtime:
        condition: service_healthy
    networks:
      - coolify-local-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/up"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  # PostgreSQL Database - Local Development
  coolify-db:
    image: postgres:17-alpine
    container_name: coolify-db-local
    restart: unless-stopped
    environment:
      POSTGRES_DB: coolify
      POSTGRES_USER: coolify
      POSTGRES_PASSWORD: ${DB_PASSWORD:-coolify_local_secret}
    volumes:
      - coolify-db-data:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d:ro
    ports:
      - "5432:5432"
    networks:
      - coolify-local-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U coolify -d coolify"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Redis for caching and queues - Local Development
  coolify-redis:
    image: redis:7-alpine
    container_name: coolify-redis-local
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD:-redis_local_secret} --appendonly yes
    volumes:
      - coolify-redis-data:/data
    ports:
      - "6379:6379"
    networks:
      - coolify-local-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-redis_local_secret}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  # Queue Worker - Local Development
  coolify-worker:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: coolify-worker-local
    restart: unless-stopped
    command: php artisan queue:work --tries=3 --timeout=90 --sleep=3
    environment:
      APP_NAME: Coolify
      APP_ENV: local
      APP_DEBUG: "true"
      APP_URL: http://localhost:8000
      APP_KEY: ${APP_KEY:-base64:your-local-app-key-here}
      DB_CONNECTION: pgsql
      DB_HOST: coolify-db
      DB_PORT: 5432
      DB_DATABASE: coolify
      DB_USERNAME: coolify
      DB_PASSWORD: ${DB_PASSWORD:-coolify_local_secret}
      REDIS_HOST: coolify-redis
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis_local_secret}
      REDIS_PORT: 6379
      CACHE_STORE: redis
      SESSION_DRIVER: redis
      QUEUE_CONNECTION: redis
    volumes:
      - coolify-storage:/var/www/html/storage
      - /var/run/docker.sock:/var/run/docker.sock
      - ./app:/var/www/html/app:cached
      - ./config:/var/www/html/config:cached
      - ./database:/var/www/html/database:cached
      - ./resources:/var/www/html/resources:cached
      - ./routes:/var/www/html/routes:cached
    depends_on:
      coolify:
        condition: service_healthy
      coolify-db:
        condition: service_healthy
      coolify-redis:
        condition: service_healthy
    networks:
      - coolify-local-network

  # Soketi WebSocket Server for real-time updates - Local Development
  coolify-realtime:
    image: quay.io/soketi/soketi:1.6-16-alpine
    container_name: coolify-realtime-local
    restart: unless-stopped
    ports:
      - "6001:6001"
    environment:
      SOKETI_DEBUG: "1"
      SOKETI_DEFAULT_APP_ID: "coolify"
      SOKETI_DEFAULT_APP_KEY: "coolify"
      SOKETI_DEFAULT_APP_SECRET: "coolify"
      SOKETI_USER_AUTHENTICATION_TIMEOUT: 3000
    networks:
      - coolify-local-network
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:6001/ready"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

  # Nginx for local development (optional, for SSL testing)
  nginx:
    image: nginx:alpine
    container_name: coolify-nginx-local
    restart: unless-stopped
    ports:
      - "8080:80"
      - "8443:443"
    volumes:
      - ./docker/nginx/local.conf:/etc/nginx/conf.d/default.conf:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - coolify
    networks:
      - coolify-local-network
    profiles:
      - nginx

volumes:
  coolify-storage:
    driver: local
  coolify-db-data:
    driver: local
  coolify-redis-data:
    driver: local

networks:
  coolify-local-network:
    driver: bridge
